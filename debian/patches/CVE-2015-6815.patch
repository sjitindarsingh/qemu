From b947ac2bf26479e710489739c465c8af336599e7 Mon Sep 17 00:00:00 2001
From: P J P <pjp@fedoraproject.org>
Date: Fri, 4 Sep 2015 17:21:06 +0100
Subject: [PATCH] e1000: Avoid infinite loop in processing transmit descriptor (CVE-2015-6815)

While processing transmit descriptors, it could lead to an infinite
loop if 'bytes' was to become zero; Add a check to avoid it.

[The guest can force 'bytes' to 0 by setting the hdr_len and mss
descriptor fields to 0.
--Stefan]

Signed-off-by: P J P <pjp@fedoraproject.org>
Signed-off-by: Stefan Hajnoczi <stefanha@redhat.com>
Reviewed-by: Thomas Huth <thuth@redhat.com>
Message-id: 1441383666-6590-1-git-send-email-stefanha@redhat.com
---
 hw/net/e1000.c |    3 ++-
 1 files changed, 2 insertions(+), 1 deletions(-)

Index: qemu-2.3+dfsg/hw/net/e1000.c
===================================================================
--- qemu-2.3+dfsg.orig/hw/net/e1000.c	2015-09-23 15:05:38.244162940 -0400
+++ qemu-2.3+dfsg/hw/net/e1000.c	2015-09-23 15:05:38.240162893 -0400
@@ -737,7 +737,8 @@
                 memmove(tp->data, tp->header, tp->hdr_len);
                 tp->size = tp->hdr_len;
             }
-        } while (split_size -= bytes);
+            split_size -= bytes;
+        } while (bytes && split_size);
     } else if (!tp->tse && tp->cptse) {
         // context descriptor TSE is not set, while data descriptor TSE is set
         DBGOUT(TXERR, "TCP segmentation error\n");
