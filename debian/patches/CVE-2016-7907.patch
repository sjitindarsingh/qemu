Backport of:

From 81f17e0d435c3db3a3e67e0d32ebf9c98973211f Mon Sep 17 00:00:00 2001
From: Prasad J Pandit <pjp@fedoraproject.org>
Date: Thu, 2 Feb 2017 16:16:24 +0530
Subject: [PATCH] net: imx: limit buffer descriptor count

i.MX Fast Ethernet Controller uses buffer descriptors to manage
data flow to/fro receive & transmit queues. While transmitting
packets, it could continue to read buffer descriptors if a buffer
descriptor has length of zero and has crafted values in bd.flags.
Set an upper limit to number of buffer descriptors.

Reported-by: Li Qiang <liqiang6-s@360.cn>
Signed-off-by: Prasad J Pandit <pjp@fedoraproject.org>
Signed-off-by: Jason Wang <jasowang@redhat.com>
---
 hw/net/imx_fec.c | 10 ++++++----
 1 file changed, 6 insertions(+), 4 deletions(-)

Index: qemu-2.5+dfsg/hw/net/imx_fec.c
===================================================================
--- qemu-2.5+dfsg.orig/hw/net/imx_fec.c	2017-04-04 13:50:05.264324999 -0400
+++ qemu-2.5+dfsg/hw/net/imx_fec.c	2017-04-04 13:50:05.264324999 -0400
@@ -51,6 +51,8 @@
         } \
     } while (0)
 
+#define IMX_MAX_DESC    1024
+
 static const VMStateDescription vmstate_imx_fec = {
     .name = TYPE_IMX_FEC,
     .version_id = 1,
@@ -263,12 +265,12 @@
 
 static void imx_fec_do_tx(IMXFECState *s)
 {
-    int frame_size = 0;
+    int frame_size = 0, descnt = 0;
     uint8_t frame[FEC_MAX_FRAME_SIZE];
     uint8_t *ptr = frame;
     uint32_t addr = s->tx_descriptor;
 
-    while (1) {
+    while (descnt++ < IMX_MAX_DESC) {
         IMXFECBufDesc bd;
         int len;
 
