From 791f97758e223de3290592d169f8e6339c281714 Mon Sep 17 00:00:00 2001
From: Li Qiang <liqiang6-s@360.cn>
Date: Tue, 8 Nov 2016 04:11:10 -0800
Subject: [PATCH] usb: ehci: fix memory leak in ehci_init_transfer

In ehci_init_transfer function, if the 'cpage' is bigger than 4,
it doesn't free the 'p->sgl' once allocated previously thus leading
a memory leak issue. This patch avoid this.

Signed-off-by: Li Qiang <liqiang6-s@360.cn>
Message-id: 5821c0f4.091c6b0a.e0c92.e811@mx.google.com
Signed-off-by: Gerd Hoffmann <kraxel@redhat.com>
---
 hw/usb/hcd-ehci.c | 1 +
 1 file changed, 1 insertion(+)

Index: qemu-2.5+dfsg/hw/usb/hcd-ehci.c
===================================================================
--- qemu-2.5+dfsg.orig/hw/usb/hcd-ehci.c	2017-04-04 15:59:56.612431461 -0400
+++ qemu-2.5+dfsg/hw/usb/hcd-ehci.c	2017-04-04 15:59:56.608431409 -0400
@@ -1187,6 +1187,7 @@
     while (bytes > 0) {
         if (cpage > 4) {
             fprintf(stderr, "cpage out of range (%d)\n", cpage);
+            qemu_sglist_destroy(&p->sgl);
             return -1;
         }
 
