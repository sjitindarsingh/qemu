Backport of:

From 702dbcc274e2ca43be20ba64c758c0ca57dab91d Mon Sep 17 00:00:00 2001
From: Li Qiang <liq3ea@gmail.com>
Date: Wed, 23 Nov 2016 13:53:34 +0100
Subject: [PATCH] 9pfs: add cleanup operation in FileOperations

Currently, the backend of VirtFS doesn't have a cleanup
function. This will lead resource leak issues if the backed
driver allocates resources. This patch addresses this issue.

Signed-off-by: Li Qiang <liq3ea@gmail.com>
Reviewed-by: Greg Kurz <groug@kaod.org>
Signed-off-by: Greg Kurz <groug@kaod.org>
---
 fsdev/file-op-9p.h | 1 +
 hw/9pfs/9p.c       | 6 ++++++
 2 files changed, 7 insertions(+)

Index: qemu-2.5+dfsg/fsdev/file-op-9p.h
===================================================================
--- qemu-2.5+dfsg.orig/fsdev/file-op-9p.h	2017-04-04 15:07:14.791807083 -0400
+++ qemu-2.5+dfsg/fsdev/file-op-9p.h	2017-04-04 15:07:14.787807031 -0400
@@ -102,6 +102,7 @@
 {
     int (*parse_opts)(QemuOpts *, struct FsDriverEntry *);
     int (*init)(struct FsContext *);
+    void (*cleanup)(struct FsContext *);
     int (*lstat)(FsContext *, V9fsPath *, struct stat *);
     ssize_t (*readlink)(FsContext *, V9fsPath *, char *, size_t);
     int (*chmod)(FsContext *, V9fsPath *, FsCred *);
Index: qemu-2.5+dfsg/hw/9pfs/virtio-9p-device.c
===================================================================
--- qemu-2.5+dfsg.orig/hw/9pfs/virtio-9p-device.c	2017-04-04 15:07:14.791807083 -0400
+++ qemu-2.5+dfsg/hw/9pfs/virtio-9p-device.c	2017-04-04 15:07:45.560202408 -0400
@@ -139,6 +139,9 @@
     register_savevm(dev, "virtio-9p", -1, 1, virtio_9p_save, virtio_9p_load, s);
     return;
 out:
+    if (s->ops->cleanup && s->ctx.private) {
+        s->ops->cleanup(&s->ctx);
+    }
     g_free(s->tag);
     g_free(s->ctx.fs_root);
     virtio_cleanup(vdev);
@@ -152,6 +155,9 @@
 
     virtio_cleanup(vdev);
     unregister_savevm(dev, "virtio-9p", s);
+    if (s->ops->cleanup) {
+        s->ops->cleanup(&s->ctx);
+    }
     g_free(s->tag);
     g_free(s->ctx.fs_root);
 }
