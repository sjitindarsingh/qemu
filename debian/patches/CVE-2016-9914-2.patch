Backport of:

From f2b58c43758efc61e2a49b899f5e58848489d0dc Mon Sep 17 00:00:00 2001
From: Greg Kurz <groug@kaod.org>
Date: Tue, 3 Jan 2017 17:28:44 +0100
Subject: [PATCH] 9pfs: fix crash when fsdev is missing

If the user passes -device virtio-9p without the corresponding -fsdev, QEMU
dereferences a NULL pointer and crashes.

This is a 2.8 regression introduced by commit 702dbcc274e2c.

Signed-off-by: Greg Kurz <groug@kaod.org>
Reviewed-by: Li Qiang <liq3ea@gmail.com>
---
 hw/9pfs/9p.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

Index: qemu-2.5+dfsg/hw/9pfs/virtio-9p-device.c
===================================================================
--- qemu-2.5+dfsg.orig/hw/9pfs/virtio-9p-device.c	2017-04-04 15:07:45.560202408 -0400
+++ qemu-2.5+dfsg/hw/9pfs/virtio-9p-device.c	2017-04-04 15:09:15.673360218 -0400
@@ -139,7 +139,7 @@
     register_savevm(dev, "virtio-9p", -1, 1, virtio_9p_save, virtio_9p_load, s);
     return;
 out:
-    if (s->ops->cleanup && s->ctx.private) {
+    if (s->ops && s->ops->cleanup && s->ctx.private) {
         s->ops->cleanup(&s->ctx);
     }
     g_free(s->tag);
