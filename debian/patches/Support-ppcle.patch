From 04c3f5652d6a890a1771b6f56f686584c1790c52 Mon Sep 17 00:00:00 2001
From: Serge Hallyn <serge.hallyn@ubuntu.com>
Date: Wed, 27 Aug 2014 17:46:54 +0000
Subject: [PATCH 1/1] Support ppc64le binfmt registration

This is a part of a patch proposed by jaejunh at
https://bugs.launchpad.net/ubuntu/+source/qemu/+bug/1358268
which enables running ppcle binaries.

Signed-off-by: Serge Hallyn <serge.hallyn@ubuntu.com>
---
 configure                            | 7 +++++++
 default-configs/ppcle-linux-user.mak | 2 ++
 linux-user/ppc/syscall.h             | 4 ++++
 3 files changed, 13 insertions(+)
 create mode 100644 default-configs/ppcle-linux-user.mak

Index: qemu-2.1+dfsg/configure
===================================================================
--- qemu-2.1+dfsg.orig/configure
+++ qemu-2.1+dfsg/configure
@@ -5003,6 +5003,13 @@ case "$target_name" in
     TARGET_ABI_DIR=ppc
     gdb_xml_files="power64-core.xml power-fpu.xml power-altivec.xml power-spe.xml"
   ;;
+  ppcle)
+    TARGET_ARCH=ppc64
+    TARGET_BASE_ARCH=ppc
+    TARGET_ABI_DIR=ppc
+    echo "TARGET_ABI32=y" >> $config_target_mak
+    gdb_xml_files="power64-core.xml power-fpu.xml power-altivec.xml power-spe.xml"
+  ;;
   ppc64abi32)
     TARGET_ARCH=ppc64
     TARGET_BASE_ARCH=ppc
Index: qemu-2.1+dfsg/default-configs/ppcle-linux-user.mak
===================================================================
--- /dev/null
+++ qemu-2.1+dfsg/default-configs/ppcle-linux-user.mak
@@ -0,0 +1,2 @@
+# Default configuration for ppcle-linux-user
+CONFIG_LIBDECNUMBER=y
Index: qemu-2.1+dfsg/linux-user/ppc/syscall.h
===================================================================
--- qemu-2.1+dfsg.orig/linux-user/ppc/syscall.h
+++ qemu-2.1+dfsg/linux-user/ppc/syscall.h
@@ -64,7 +64,11 @@ struct target_revectored_struct {
 #define UNAME_MACHINE "ppc64le"
 #endif
 #else
+#ifdef TARGET_WORDS_BIGENDIAN
 #define UNAME_MACHINE "ppc"
+#else
+#define UNAME_MACHINE "ppcle"
+#endif
 #endif
 #define UNAME_MINIMUM_RELEASE "2.6.32"
 
