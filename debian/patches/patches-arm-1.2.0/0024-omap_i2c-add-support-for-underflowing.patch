From 99329f543d95052e10baee6dc851471d522be954 Mon Sep 17 00:00:00 2001
From: Riku Voipio <riku.voipio@nokia.com>
Date: Wed, 4 Jul 2012 11:18:40 +0000
Subject: [PATCH 24/77] omap_i2c: add support for underflowing

kernel workaround for OMAP3430 Errata 1.153 requires this..
---
 hw/omap_i2c.c |    5 ++++-
 1 file changed, 4 insertions(+), 1 deletion(-)

diff --git a/hw/omap_i2c.c b/hw/omap_i2c.c
index 94d2277..0b254e7 100644
--- a/hw/omap_i2c.c
+++ b/hw/omap_i2c.c
@@ -196,7 +196,10 @@ static uint32_t omap_i2c_read(void *opaque, target_phys_addr_t addr)
         return s->mask;
 
     case 0x08:	/* I2C_STAT */
-        return s->stat | (i2c_bus_busy(s->bus) << 12);
+        ret = s->stat | (i2c_bus_busy(s->bus) << 12 );
+        if (s->revision >= OMAP3_INTR_REV && (s->stat & 0x4010)) /* XRDY or XDR  */
+            s->stat |= 1 << 10; /* XUDF as required by errata 1.153 */
+        return ret;
 
     case 0x0c: /* I2C_IV / I2C_WE */
         if (s->revision >= OMAP3_INTR_REV)
-- 
1.7.9.5

