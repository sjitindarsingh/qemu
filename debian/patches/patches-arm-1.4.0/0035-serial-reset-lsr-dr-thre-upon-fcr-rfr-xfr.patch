From fc286af9aa8ff763cb28556bf12e044fc368683b Mon Sep 17 00:00:00 2001
From: Peter Maydell <peter.maydell@linaro.org>
Date: Mon, 18 Feb 2013 16:58:29 +0000
Subject: [PATCH 35/77] serial: reset lsr dr/thre upon fcr rfr/xfr
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Includes:

further fix serial.c fifo clear

when receive fifo is requested to be cleared and there is a received byte
pending to be read, accept the byte while discarding it so it will not stay
pending.

yet another serial tweak

...so needs review!

Signed-off-by: Juha Riihim√§ki <juha.riihimaki@nokia.com>
---
 hw/serial.c | 7 +++++++
 1 file changed, 7 insertions(+)

diff --git a/hw/serial.c b/hw/serial.c
index d71e8f8..c8a015a 100644
--- a/hw/serial.c
+++ b/hw/serial.c
@@ -372,10 +372,17 @@ static void serial_ioport_write(void *opaque, hwaddr addr, uint64_t val,
             qemu_del_timer(s->fifo_timeout_timer);
             s->timeout_ipending=0;
             fifo_clear(s,RECV_FIFO);
+            if ((s->lsr & UART_LSR_DR)) {
+                s->lsr &= ~(UART_LSR_DR | UART_LSR_BI | UART_LSR_OE);
+                if (!(s->mcr & UART_MCR_LOOP)) {
+                    qemu_chr_accept_input(s->chr);
+                }
+            }
         }
 
         if (val & UART_FCR_XFR) {
             fifo_clear(s,XMIT_FIFO);
+            s->lsr |= UART_LSR_THRE;
         }
 
         if (val & UART_FCR_FE) {
-- 
1.8.1.2

